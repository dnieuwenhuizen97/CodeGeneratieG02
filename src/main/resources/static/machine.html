<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Machine</title>
</head>
<body>
<div class="navbar">
    <a href="http://localhost:8080/login.html">Login</a>
    <a href="http://localhost:8080/machine.html">Machine</a>
    <a href="http://localhost:8080/index.html">Home</a>
</div>
<form id="machineTransferForm">
    <label>Amount:</label> <input id="amount" type="text"><br>
    <label>Transfer type:</label><select id="transferType"><option value="withdraw">Withdraw</option><option value="deposit">Deposit</option></select>
    <br />
    <br>

<input type="button" id="machineTransfer" value="Peform transfer" onclick="PostMachineTransfer()">

</form>

<form id="userRequestsForm">
    <input type="button" id="userRequests" value="Get requests" onclick="GetUserRequests()">
</form>
<table id="userRequestsTable"></table>


<script>
function GetUserRequests()
{
  let table = document.getElementById("userRequestsTable");
        table.innerHTML = "   <tr>\n" +
            "       <th>Request id</th>\n" +
            "       <th>Firstname</th>\n" +
            "       <th>Lastname</th>\n" +
            "       <th>Email</th>\n" +
            "       <th>Accept/Decline</th>\n" +
            "   </tr>";


        var xhr =  new XMLHttpRequest();
        xhr.open('GET','http://localhost:8080/users/requests');
        xhr.setRequestHeader("ApiKeyAuth" ,sessionStorage.getItem("AuthToken"));
        xhr.onload= (e) => {
            alert(xhr.status);
            let response = JSON.parse(xhr.response);
            for (i=0;i<response.length;i++){
                table.innerHTML+="<tr><td>%j</td><td>%k</td><td>%l</td><td>%m</td><td>%n</td></tr>"
                    .replace("%j",JSON.stringify(response[i].registerId))
                    .replace("%k",JSON.stringify(response[i].firstName))
                    .replace("%l",JSON.stringify(response[i].lastName))
                    .replace("%m",JSON.stringify(response[i].email))
                    .replace("%n","<button onclick='acceptRequest("+ JSON.stringify(response[i].firstName) +","+ JSON.stringify(response[i].lastName)+ "," +JSON.stringify(response[i].password) + ","+JSON.stringify(response[i].email)+ ")'>Accept</button><button onclick='declineRequest("+ response[i].registerId+ ")'>Decline</button>")

            }
        }
        xhr.send();
}
function acceptRequest(firstName, lastName, password, email)
{

        var xhr =  new XMLHttpRequest();
        xhr.open('POST','http://localhost:8080/users');
        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.setRequestHeader("ApiKeyAuth", sessionStorage.getItem("AuthToken"));
        xhr.onload= (e) => {
            alert(xhr.status);
        }
        xhr.send(JSON.stringify(
            {
                "firstName": firstName,
                "lastName": lastName,
                "email":  email,
                "password": password,
                "user_type": "customer"
            }
        ));
}

function declineRequest(requestId)
{
    var xhr =  new XMLHttpRequest();
        xhr.open('DELETE','http://localhost:8080/users/requests/' + requestId);
        xhr.setRequestHeader("ApiKeyAuth" ,sessionStorage.getItem("AuthToken"));
        xhr.onload= (e) => {
            alert(xhr.status);
        }
        xhr.send();;
}

function PostMachineTransfer()
{
        var amount = document.getElementById("amount").value;
        var t = document.getElementById("transferType");
        var transferType = t.options[t.selectedIndex].value;

        var xhr =  new XMLHttpRequest();

        xhr.open('POST','http://localhost:8080/users/'+sessionStorage.getItem("UserId")+ '/machine');
        xhr.setRequestHeader("Content-Type", "application/json" );
        xhr.setRequestHeader("ApiKeyAuth" ,sessionStorage.getItem("AuthToken"));
        xhr.onload= (e) => {
        //haal transactie op
            alert(xhr.status);
        }
        xhr.send(JSON.stringify(
            {
                "amount": amount,
                "transfer_type": transferType
            }
        ));
}

</script>
</body>
</html>